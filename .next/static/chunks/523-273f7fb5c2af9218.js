"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[523],{9547:function(r,e,t){t.d(e,{b:function(){return o},w:function(){return s}});var a=t(7437),i=t(2265);let n=(0,i.createContext)(void 0),o=()=>{let r=(0,i.useContext)(n);if(!r)throw Error("useAppContext must be used within an AppProvider");return r},s=r=>{let{children:e}=r,[t,o]=(0,i.useState)(!1),[s,l]=(0,i.useState)(null),[u,c]=(0,i.useState)(null),[d,g]=(0,i.useState)([]);return(0,a.jsx)(n.Provider,{value:{sidebarOpen:t,toggleSidebar:()=>{o(!t)},user:s,setUser:l,organization:u,setOrganization:c,workflows:d,setWorkflows:g},children:e})}},4362:function(r,e,t){t.d(e,{H:function(){return c},a:function(){return u}});var a=t(7437),i=t(2265),n=t(7423),o=t(5526),s=t(3340);let l=(0,i.createContext)(void 0),u=()=>{let r=(0,i.useContext)(l);if(!r)throw Error("useAuth must be used within an AuthProvider");return r},c=r=>{let{children:e}=r,[t,u]=(0,i.useState)(null),[c,d]=(0,i.useState)(!0),{toast:g}=(0,s.pm)();(0,i.useEffect)(()=>{(async()=>{try{let e=await n.SupabaseService.getCurrentUser();if(e){var r;u({id:e.id,email:e.email,name:null===(r=e.user_metadata)||void 0===r?void 0:r.name,role:"admin"})}}catch(r){console.error("Error checking user session:",r)}finally{d(!1)}})();let{data:{subscription:r}}=o.O.auth.onAuthStateChange(async(r,e)=>{if("SIGNED_IN"===r&&(null==e?void 0:e.user)){var t;u({id:e.user.id,email:e.user.email,name:null===(t=e.user.user_metadata)||void 0===t?void 0:t.name,role:"admin"})}else"SIGNED_OUT"===r&&u(null)});return()=>r.unsubscribe()},[]);let m=async(r,e)=>{try{let{data:a,error:i}=await n.SupabaseService.signIn(r,e);if(i)return{success:!1,error:i.message};if(a.user){var t;return u({id:a.user.id,email:a.user.email,name:null===(t=a.user.user_metadata)||void 0===t?void 0:t.name,role:"admin"}),g({title:"Welcome back!",description:"Successfully signed in to ApprovalFlow"}),{success:!0}}return{success:!1,error:"Sign in failed"}}catch(r){return{success:!1,error:"An unexpected error occurred"}}},f=async(r,e,t)=>{try{let{data:a,error:i}=await n.SupabaseService.signUp(r,e,t);if(i){if(console.error("Sign up error:",i),i.message.includes("Database error"))return{success:!1,error:"Database error saving new user. Please try again."};if(i.message.includes("User already registered"))return{success:!1,error:"An account with this email already exists. Please sign in instead."};return{success:!1,error:i.message}}if(a.user){try{let{error:r}=await n.SupabaseService.createUser({email:a.user.email,name:t,role:"admin"});r&&(console.error("Error creating user record:",r),g({title:"Account created with warning",description:"Account created but there was an issue with database setup. Please contact support.",variant:"destructive"}))}catch(r){console.error("Database error during signup:",r)}return u({id:a.user.id,email:a.user.email,name:t,role:"admin"}),g({title:"Account created!",description:"Welcome to ApprovalFlow"}),{success:!0}}return{success:!1,error:"Sign up failed"}}catch(r){return console.error("Unexpected error during signup:",r),{success:!1,error:"An unexpected error occurred during sign up"}}},w=async()=>{try{await n.SupabaseService.signOut(),u(null),g({title:"Signed out",description:"You have been successfully signed out"})}catch(r){console.error("Error signing out:",r)}},h=async()=>{try{let e=await n.SupabaseService.getCurrentUser();if(e){var r;u({id:e.id,email:e.email,name:null===(r=e.user_metadata)||void 0===r?void 0:r.name,role:"admin"})}}catch(r){console.error("Error refreshing user:",r)}};return(0,a.jsx)(l.Provider,{value:{user:t,loading:c,signIn:m,signUp:f,signOut:w,refreshUser:h},children:e})}},3340:function(r,e,t){t.d(e,{pm:function(){return g}});var a=t(2265);let i=0,n=new Map,o=r=>{if(n.has(r))return;let e=setTimeout(()=>{n.delete(r),c({type:"REMOVE_TOAST",toastId:r})},1e6);n.set(r,e)},s=(r,e)=>{switch(e.type){case"ADD_TOAST":return{...r,toasts:[e.toast,...r.toasts].slice(0,1)};case"UPDATE_TOAST":return{...r,toasts:r.toasts.map(r=>r.id===e.toast.id?{...r,...e.toast}:r)};case"DISMISS_TOAST":{let{toastId:t}=e;return t?o(t):r.toasts.forEach(r=>{o(r.id)}),{...r,toasts:r.toasts.map(r=>r.id===t||void 0===t?{...r,open:!1}:r)}}case"REMOVE_TOAST":if(void 0===e.toastId)return{...r,toasts:[]};return{...r,toasts:r.toasts.filter(r=>r.id!==e.toastId)}}},l=[],u={toasts:[]};function c(r){u=s(u,r),l.forEach(r=>{r(u)})}function d(r){let{...e}=r,t=(i=(i+1)%Number.MAX_SAFE_INTEGER).toString(),a=()=>c({type:"DISMISS_TOAST",toastId:t});return c({type:"ADD_TOAST",toast:{...e,id:t,open:!0,onOpenChange:r=>{r||a()}}}),{id:t,dismiss:a,update:r=>c({type:"UPDATE_TOAST",toast:{...r,id:t}})}}function g(){let[r,e]=a.useState(u);return a.useEffect(()=>(l.push(e),()=>{let r=l.indexOf(e);r>-1&&l.splice(r,1)}),[r]),{...r,toast:d,dismiss:r=>c({type:"DISMISS_TOAST",toastId:r})}}},7423:function(r,e,t){t.d(e,{SupabaseService:function(){return i}});var a=t(5526);class i{static async signUp(r,e,t){let{data:i,error:n}=await a.O.auth.signUp({email:r,password:e,options:{data:{name:t}}});return{data:i,error:n}}static async signIn(r,e){let{data:t,error:i}=await a.O.auth.signInWithPassword({email:r,password:e});return{data:t,error:i}}static async signOut(){let{error:r}=await a.O.auth.signOut();return{error:r}}static async getCurrentUser(){let{data:{user:r}}=await a.O.auth.getUser();return r}static async createOrganization(r){let{data:e,error:t}=await a.O.from("organizations").insert([r]).select().single();return{data:e,error:t}}static async getOrganization(r){let{data:e,error:t}=await a.O.from("organizations").select("*").eq("id",r).single();return{data:e,error:t}}static async createWorkflow(r){let{data:e,error:t}=await a.O.from("workflows").insert([r]).select().single();return{data:e,error:t}}static async createWorkflowSteps(r){let{data:e,error:t}=await a.O.from("workflow_steps").insert(r).select();return{data:e,error:t}}static async createWorkflowWithSteps(r,e){try{let{data:t,error:a}=await this.createWorkflow(r);if(a)return{data:null,error:a};let i=e.map((r,e)=>({workflow_id:t.id,name:r.name,approver_email:r.approver,order_index:e+1,required:r.required})),{data:n,error:o}=await this.createWorkflowSteps(i);if(o)return await this.deleteWorkflow(t.id),{data:null,error:o};return{data:{workflow:t,steps:n},error:null}}catch(r){return{data:null,error:r}}}static async getWorkflows(r){let{data:e,error:t}=await a.O.from("workflows").select("*").eq("organization_id",r).order("created_at",{ascending:!1});return{data:e,error:t}}static async updateWorkflow(r,e){let{data:t,error:i}=await a.O.from("workflows").update(e).eq("id",r).select().single();return{data:t,error:i}}static async deleteWorkflow(r){let{error:e}=await a.O.from("workflows").delete().eq("id",r);return{error:e}}static async createUser(r){try{let e=await this.getCurrentUser();if(!e)return{data:null,error:"No authenticated user"};let t={id:e.id,email:r.email,name:r.name,role:r.role,organization_id:r.organization_id},{data:i,error:n}=await a.O.from("users").select("*").eq("id",e.id).maybeSingle();if(n&&console.error("Error checking existing user:",n),i){let{data:t,error:i}=await a.O.from("users").update({organization_id:r.organization_id,name:r.name,role:r.role}).eq("id",e.id).select().single();if(i)return console.error("Error updating existing user:",i),{data:null,error:i.message};return{data:t,error:null}}{let{data:i,error:n}=await a.O.from("users").insert([t]).select().single();if(n){if(console.error("Error creating new user:",n),n.message.includes("new row violates row-level security policy")){console.log("RLS policy blocked user creation, trying manual creation...");let{data:t,error:i}=await a.O.rpc("create_user_if_not_exists",{user_id:e.id,user_email:r.email,user_name:r.name||"User"});if(i)return console.error("Manual user creation also failed:",i),{data:null,error:"Failed to create user record. Please try again."};let{data:n,error:o}=await this.getUserById(e.id);return{data:n,error:o}}return{data:null,error:n.message}}return{data:i,error:null}}}catch(r){return console.error("Error in createUser:",r),{data:null,error:r}}}static async getUsers(r){let{data:e,error:t}=await a.O.from("users").select("*").eq("organization_id",r);return{data:e,error:t}}static async getUserByEmail(r){let{data:e,error:t}=await a.O.from("users").select("*").eq("email",r).maybeSingle();return{data:e,error:t}}static async getUserById(r){let{data:e,error:t}=await a.O.from("users").select("*").eq("id",r).maybeSingle();return{data:e,error:t}}static async getCurrentUserOrganization(){try{let r=await this.getCurrentUser();if(!r)return{data:null,error:"No authenticated user"};let{data:e,error:t}=await this.getUserById(r.id);if(t||!e)return{data:null,error:t||"User not found"};if(e.organization_id){let{data:r,error:t}=await this.getOrganization(e.organization_id);return{data:r,error:t}}return{data:null,error:"User has no organization"}}catch(r){return{data:null,error:r}}}static async userHasOrganization(){try{let r=await this.getCurrentUser();if(!r)return!1;let{data:e,error:t}=await this.getUserById(r.id);if(t||!e)return!1;return!!e.organization_id}catch(r){return console.error("Error checking user organization:",r),!1}}static async getCurrentUserWithOrganization(){try{let r=await this.getCurrentUser();if(!r)return{data:null,error:"No authenticated user"};let{data:e,error:t}=await this.getUserById(r.id);if(t||!e)return{data:null,error:t||"User not found"};if(e.organization_id){let{data:r,error:t}=await this.getOrganization(e.organization_id);if(t)return{data:null,error:t};return{data:{user:e,organization:r},error:null}}return{data:{user:e,organization:null},error:null}}catch(r){return{data:null,error:r}}}static async isEmailInUse(r){let{data:e,error:t}=await a.O.from("users").select("id, organization_id").eq("email",r).maybeSingle();return t?(console.error("Error checking email:",t),{isInUse:!1,error:t}):{isInUse:!!e,organizationId:null==e?void 0:e.organization_id,error:null}}static async addUserToOrganization(r,e){try{let t=await this.getCurrentUser();if(!t)return{data:null,error:"Authentication required"};let{isInUse:i,organizationId:n}=await this.isEmailInUse(r.email);if(i){if(n===e)return{data:null,error:"User is already in this organization"};return{data:null,error:"Email is already in use by another organization"}}let{data:o,error:s}=await a.O.from("roles").select("id").eq("name",r.role).single();if(s||!o)return{data:null,error:"Invalid role specified"};let{data:l,error:u}=await a.O.from("users").insert([{email:r.email,name:r.name,role:r.role,organization_id:e}]).select().single();if(u)return console.error("Error creating user:",u),{data:null,error:u.message};let{error:c}=await a.O.from("user_roles").insert([{user_id:l.id,role_id:o.id,organization_id:e,assigned_by:t.id}]);if(c)return console.error("Error assigning role:",c),await this.deleteUser(l.id),{data:null,error:"Failed to assign role to user"};return{data:l,error:null}}catch(r){return console.error("Error adding user to organization:",r),{data:null,error:r}}}static async getUsersWithRoles(r){try{let{data:e,error:t}=await a.O.from("users").select("\n          *,\n          user_roles (\n            role_id,\n            roles (\n              name,\n              description,\n              permissions\n            )\n          )\n        ").eq("organization_id",r).order("created_at",{ascending:!1});if(t)return console.error("Error fetching users with roles:",t),{data:null,error:t};return{data:e,error:null}}catch(r){return console.error("Error fetching users with roles:",r),{data:null,error:r}}}static async deleteUser(r){try{if(!await this.getCurrentUser())return{error:"Authentication required"};let{data:e}=await this.getCurrentUserWithOrganization();if(!(null==e?void 0:e.user)||"admin"!==e.user.role)return{error:"Insufficient permissions"};let{error:t}=await a.O.from("users").delete().eq("id",r);if(t)return console.error("Error deleting user:",t),{error:t.message};return{error:null}}catch(r){return console.error("Error deleting user:",r),{error:r}}}static async createInvitation(r,e){try{var t;let i=await this.getCurrentUser();if(!i)return{data:null,error:"Authentication required"};let{isInUse:n,organizationId:o}=await this.isEmailInUse(r.email);if(n){if(o===e)return{data:null,error:"User is already in this organization"};return{data:null,error:"Email is already in use by another organization"}}let{data:s,error:l}=await a.O.from("roles").select("id").eq("name",r.role).single();if(l||!s)return{data:null,error:"Invalid role specified"};let u=crypto.randomUUID(),c=new Date;c.setDate(c.getDate()+7);let{data:d,error:g}=await a.O.from("invitations").insert([{email:r.email.trim(),name:null===(t=r.name)||void 0===t?void 0:t.trim(),role_id:s.id,organization_id:e,invited_by:i.id,token:u,expires_at:c.toISOString()}]).select().single();if(g)return console.error("Error creating invitation:",g),{data:null,error:g.message};return{data:d,error:null}}catch(r){return console.error("Error creating invitation:",r),{data:null,error:r}}}static async getInvitations(r){try{let{data:e,error:t}=await a.O.from("invitations").select("\n          *,\n          roles (\n            name,\n            description\n          ),\n          users!invitations_invited_by_fkey (\n            name,\n            email\n          )\n        ").eq("organization_id",r).order("created_at",{ascending:!1});if(t)return console.error("Error fetching invitations:",t),{data:null,error:t};return{data:e,error:null}}catch(r){return console.error("Error fetching invitations:",r),{data:null,error:r}}}static async cancelInvitation(r){try{if(!await this.getCurrentUser())return{error:"Authentication required"};let{data:e}=await this.getCurrentUserWithOrganization();if(!(null==e?void 0:e.user)||"admin"!==e.user.role)return{error:"Insufficient permissions"};let{error:t}=await a.O.from("invitations").delete().eq("id",r);if(t)return console.error("Error canceling invitation:",t),{error:t.message};return{error:null}}catch(r){return console.error("Error canceling invitation:",r),{error:r}}}static async acceptInvitation(r,e){try{let{data:t,error:i}=await a.O.from("invitations").select("\n          *,\n          roles (\n            name\n          ),\n          organizations (\n            name\n          )\n        ").eq("token",r).eq("status","pending").single();if(i||!t)return{data:null,error:"Invalid or expired invitation"};if(new Date(t.expires_at)<new Date)return{data:null,error:"Invitation has expired"};if(t.email!==e.email)return{data:null,error:"Email does not match invitation"};let{data:n,error:o}=await a.O.auth.signUp({email:e.email,password:e.password,options:{data:{name:e.name}}});if(o)return{data:null,error:o.message};if(!n.user)return{data:null,error:"Failed to create user account"};let{error:s}=await a.O.from("users").insert([{id:n.user.id,email:e.email,name:e.name,role:t.roles.name,organization_id:t.organization_id}]);if(s)return console.error("Error creating user record:",s),{data:null,error:"Failed to create user record"};let{error:l}=await a.O.from("user_roles").insert([{user_id:n.user.id,role_id:t.role_id,organization_id:t.organization_id,assigned_by:t.invited_by}]);if(l)return console.error("Error assigning role:",l),await a.O.auth.admin.deleteUser(n.user.id),{data:null,error:"Failed to assign role to user"};let{error:u}=await a.O.from("invitations").update({status:"accepted",accepted_at:new Date().toISOString()}).eq("id",t.id);return u&&console.error("Error updating invitation:",u),{data:{user:n.user,organization:t.organizations,role:t.roles.name},error:null}}catch(r){return console.error("Error accepting invitation:",r),{data:null,error:r}}}static async resendInvitation(r){try{if(!await this.getCurrentUser())return{error:"Authentication required"};let{data:e}=await this.getCurrentUserWithOrganization();if(!(null==e?void 0:e.user)||"admin"!==e.user.role)return{error:"Insufficient permissions"};let{data:t,error:i}=await a.O.from("invitations").select("*").eq("id",r).single();if(i||!t)return{error:"Invitation not found"};let n=crypto.randomUUID(),o=new Date;o.setDate(o.getDate()+7);let{error:s}=await a.O.from("invitations").update({token:n,expires_at:o.toISOString(),created_at:new Date().toISOString()}).eq("id",r);if(s)return console.error("Error updating invitation:",s),{error:s.message};return{data:{token:n,expires_at:o},error:null}}catch(r){return console.error("Error resending invitation:",r),{error:r}}}}},5526:function(r,e,t){t.d(e,{O:function(){return o}});var a=t(6580);let i="https://vusxtpupkiwhnvynqgus.supabase.co",n="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ1c3h0cHVwa2l3aG52eW5xZ3VzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1MDg2OTIsImV4cCI6MjA3MDA4NDY5Mn0.PLiwKcncQUpANf8YRWIKLxBmOHIreJOfVlm2XbnSPFU";if(!i||!n)throw Error("Missing Supabase environment variables");let o=(0,a.eI)(i,n)},3448:function(r,e,t){t.d(e,{cn:function(){return n}});var a=t(1994),i=t(3335);function n(){for(var r=arguments.length,e=Array(r),t=0;t<r;t++)e[t]=arguments[t];return(0,i.m6)((0,a.W)(e))}}}]);